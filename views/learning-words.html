<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® í•™ìŠµ ë‹¨ì–´ ì„¤ì •</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .word-card {
            background: white;
            border: 2px solid #FFE5EC;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .word-card h4 {
            color: #FF6B9D;
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container" style="max-width: 1000px; margin: 40px auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div>
                <h1 style="color: #FF6B9D; margin-bottom: 5px;">ğŸ® í•™ìŠµ ë‹¨ì–´ ì„¤ì •</h1>
                <p id="storyTitle" style="color: #666; margin: 0;">ë™í™”ì±…: ë¡œë”© ì¤‘...</p>
            </div>
            <button class="btn btn-secondary" onclick="window.close()">â† ë‹«ê¸°</button>
        </div>

        <div style="background: #FFF9F0; padding: 20px; border-radius: 15px; margin-bottom: 30px;">
            <h3 style="color: #FFA500; margin-bottom: 10px;">ğŸ’¡ í•™ìŠµ ë‹¨ì–´ë€?</h3>
            <p style="color: #666; margin: 0; line-height: 1.6;">
                ë™í™”ì±…ì—ì„œ ì•„ì´ë“¤ì´ ë°°ìš¸ ìˆ˜ ìˆëŠ” <strong>8ê°œì˜ ë‹¨ì–´</strong>ë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>
                ê° ë‹¨ì–´ë§ˆë‹¤ <strong>ëœ»</strong>, <strong>ì˜ˆë¬¸</strong>, <strong>ì´ë¯¸ì§€ URL</strong>ì„ í•¨ê»˜ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                ì´ ë‹¨ì–´ë“¤ì€ <strong>ë‹¨ì–´ ì¹´ë“œ ë§¤ì¹­ ê²Œì„</strong>ì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.
            </p>
        </div>

        <div id="wordsContainer">
            <!-- JavaScriptë¡œ 8ê°œ ë‹¨ì–´ í¼ ìƒì„± -->
        </div>

        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
            <button class="btn btn-secondary" onclick="window.close()">ì·¨ì†Œ</button>
            <button class="btn btn-success" onclick="saveWords()" style="padding: 15px 40px; font-size: 18px;">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const storyId = urlParams.get('story');
        let storyData = null;

        // ë™í™”ì±… ë°ì´í„° ë¡œë“œ
        async function loadStory() {
            try {
                const response = await fetch(`/api/storybooks/${storyId}`);
                storyData = await response.json();
                
                document.getElementById('storyTitle').textContent = `ë™í™”ì±…: ${storyData.title}`;
                
                // 8ê°œ ë‹¨ì–´ í¼ ìƒì„±
                renderWordForms();
            } catch (error) {
                alert('âŒ ë™í™”ì±… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        }

        // 8ê°œ ë‹¨ì–´ ì…ë ¥ í¼ ë Œë”ë§
        function renderWordForms() {
            const container = document.getElementById('wordsContainer');
            const existingWords = storyData.learningWords || [];

            for (let i = 0; i < 8; i++) {
                const word = existingWords[i] || { word: '', meaning: '', example: '', imageUrl: '' };
                
                const card = document.createElement('div');
                card.className = 'word-card';
                card.innerHTML = `
                    <h4>ë‹¨ì–´ ${i + 1}</h4>
                    <div class="form-row">
                        <div class="form-group" style="margin: 0;">
                            <label>ë‹¨ì–´ *</label>
                            <input type="text" class="form-control" id="word${i}" value="${word.word}" placeholder="ì˜ˆ: ì™•ë¹„" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>ëœ» *</label>
                            <input type="text" class="form-control" id="meaning${i}" value="${word.meaning}" placeholder="ì˜ˆ: ì™•ì˜ ì•„ë‚´" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ì˜ˆë¬¸</label>
                        <input type="text" class="form-control" id="example${i}" value="${word.example}" placeholder="ì˜ˆ: ìƒˆë¡œìš´ ì™•ë¹„ê°€ ê¶ì „ì— ë„ì°©í–ˆì–´ìš”.">
                    </div>
                    <div class="form-group">
                        <label>ì´ë¯¸ì§€ URL *</label>
                        <input type="url" class="form-control" id="imageUrl${i}" value="${word.imageUrl}" placeholder="https://i.ibb.co/..." required>
                        ${word.imageUrl ? `<img src="${word.imageUrl}" style="max-width: 200px; margin-top: 10px; border-radius: 8px;" onerror="this.style.display='none'">` : ''}
                    </div>
                `;
                container.appendChild(card);
            }
        }

        // ì €ì¥
        async function saveWords() {
            const learningWords = [];

            for (let i = 0; i < 8; i++) {
                const word = document.getElementById(`word${i}`).value.trim();
                const meaning = document.getElementById(`meaning${i}`).value.trim();
                const example = document.getElementById(`example${i}`).value.trim();
                const imageUrl = document.getElementById(`imageUrl${i}`).value.trim();

                if (!word || !meaning || !imageUrl) {
                    alert(`âš ï¸ ë‹¨ì–´ ${i + 1}ì˜ í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ë‹¨ì–´, ëœ», ì´ë¯¸ì§€ URL)`);
                    return;
                }

                learningWords.push({ word, meaning, example, imageUrl });
            }

            try {
                const response = await fetch(`/api/admin/storybooks/${storyId}/learning-words`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ learningWords })
                });

                const result = await response.json();
                if (result.success) {
                    alert('âœ… í•™ìŠµ ë‹¨ì–´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    window.close();
                } else {
                    alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + result.error);
                }
            } catch (error) {
                alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        if (storyId) {
            loadStory();
        } else {
            alert('âŒ ë™í™”ì±… IDê°€ ì—†ìŠµë‹ˆë‹¤.');
            window.close();
        }
    </script>
</body>
</html>
