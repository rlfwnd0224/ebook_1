<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš™ï¸ ê´€ë¦¬ì í˜ì´ì§€</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="admin-header">
            <div>
                <h1 style="color: #FF6B9D; margin-bottom: 5px;">âš™ï¸ ë™í™”ì±… ê´€ë¦¬</h1>
                <p style="color: #666;">ë™í™”ì±…ì„ ì¶”ê°€í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="/" class="btn btn-secondary">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
                <button class="btn btn-primary" onclick="openCreateModal()">â• ìƒˆ ë™í™”ì±… ë§Œë“¤ê¸°</button>
            </div>
        </div>

        <div id="storybookList" class="card-grid">
            <div class="loading">ë™í™”ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤</div>
        </div>
    </div>

    <!-- ë™í™”ì±… ìƒì„± ëª¨ë‹¬ -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ìƒˆ ë™í™”ì±… ë§Œë“¤ê¸°</h2>
                <button class="close-btn" onclick="closeCreateModal()">Ã—</button>
            </div>
            
            <form id="createForm" onsubmit="createStorybook(event)">
                <div class="form-group">
                    <label>ì œëª© *</label>
                    <input type="text" class="form-control" id="title" required>
                </div>

                <div class="form-group">
                    <label>ì‘ê°€</label>
                    <input type="text" class="form-control" id="author">
                </div>

                <div class="form-group">
                    <label>í‘œì§€ ì´ë¯¸ì§€ URL *</label>
                    <input type="url" class="form-control" id="coverImageUrl" placeholder="https://example.com/image.jpg" required>
                </div>

                <div class="form-group">
                    <label>ì—°ë ¹ëŒ€</label>
                    <select class="form-control" id="ageGroup">
                        <option value="">ì„ íƒ ì•ˆ í•¨</option>
                        <option value="3-5ì„¸">3-5ì„¸</option>
                        <option value="5-7ì„¸">5-7ì„¸</option>
                        <option value="4-6ì„¸">4-6ì„¸</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                    <input type="text" class="form-control" id="tags" placeholder="ìš°ì •, ëª¨í—˜, ìì—°">
                </div>

                <div class="form-group">
                    <label>ì„¤ëª…</label>
                    <textarea class="form-control" id="description" rows="3"></textarea>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ìƒì„±í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ë™í™”ì±… í¸ì§‘ ëª¨ë‹¬ -->
    <div id="editModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">ë™í™”ì±… í¸ì§‘</h2>
                <button class="close-btn" onclick="closeEditModal()">Ã—</button>
            </div>
            
            <div id="editContent">
                <!-- Step 1: ê¸°ë³¸ ì •ë³´ -->
                <div id="step1" class="edit-step">
                    <h3 style="color: #FFA500; margin-bottom: 20px;">ğŸ“ ê¸°ë³¸ ì •ë³´</h3>
                    <form id="basicInfoForm">
                        <div class="form-group">
                            <label>ì œëª© *</label>
                            <input type="text" class="form-control" id="editTitle" required>
                        </div>

                        <div class="form-group">
                            <label>ì‘ê°€</label>
                            <input type="text" class="form-control" id="editAuthor">
                        </div>

                        <div class="form-group">
                            <label>í‘œì§€ ì´ë¯¸ì§€ URL *</label>
                            <input type="url" class="form-control" id="editCoverImageUrl" required>
                        </div>

                        <div class="form-group">
                            <label>ì—°ë ¹ëŒ€</label>
                            <select class="form-control" id="editAgeGroup">
                                <option value="">ì„ íƒ ì•ˆ í•¨</option>
                                <option value="3-5ì„¸">3-5ì„¸</option>
                                <option value="5-7ì„¸">5-7ì„¸</option>
                                <option value="4-6ì„¸">4-6ì„¸</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                            <input type="text" class="form-control" id="editTags">
                        </div>

                        <div class="form-group">
                            <label>ê³µê°œ ìƒíƒœ</label>
                            <select class="form-control" id="editIsPublished">
                                <option value="true">ê³µê°œ</option>
                                <option value="false">ë¹„ê³µê°œ</option>
                            </select>
                        </div>

                        <button type="button" class="btn btn-primary" onclick="saveBasicInfo()">ì €ì¥ ë° ë‹¤ìŒ</button>
                    </form>
                </div>

                <!-- Step 2: í†µí•© í¸ì§‘ í™”ë©´ -->
                <div id="step2" class="edit-step" style="display: none;">
                    <h3 style="color: #FFA500; margin-bottom: 20px;">ğŸ“ í˜ì´ì§€ í¸ì§‘ (ì´ë¯¸ì§€ + í…ìŠ¤íŠ¸)</h3>
                    
                    <div id="currentPageInfo" style="padding: 12px; background: #E3F2FD; border-radius: 8px; margin-bottom: 15px; font-weight: 600;"></div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- ì™¼ìª½: ì´ë¯¸ì§€ URL -->
                        <div class="form-group" style="margin: 0;">
                            <label style="display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ–¼ï¸ ì´ë¯¸ì§€ URL (í•œ ì¤„ì— í•˜ë‚˜ì”©)</span>
                                <small style="color: #666; font-weight: normal;">í˜„ì¬: <span id="imageUrlCount">0</span>ê°œ</small>
                            </label>
                            <textarea 
                                class="form-control" 
                                id="bulkImageUrls" 
                                rows="20"
                                placeholder="https://example.com/page-01.jpg
https://example.com/page-02.jpg
https://example.com/page-03.jpg"
                                style="font-family: monospace; font-size: 13px;"
                                oninput="updateCounts()"
                            ></textarea>
                        </div>

                        <!-- ì˜¤ë¥¸ìª½: í…ìŠ¤íŠ¸ -->
                        <div class="form-group" style="margin: 0;">
                            <label style="display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“– í…ìŠ¤íŠ¸ (êµ¬ë¶„ì: ---)</span>
                                <small style="color: #666; font-weight: normal;">í˜„ì¬: <span id="textCount">0</span>ê°œ</small>
                            </label>
                            <textarea 
                                class="form-control" 
                                id="bulkTexts" 
                                rows="20"
                                placeholder="ì²« ë²ˆì§¸ í˜ì´ì§€ì˜ í…ìŠ¤íŠ¸
---
ë‘ ë²ˆì§¸ í˜ì´ì§€ì˜ í…ìŠ¤íŠ¸
---
ì„¸ ë²ˆì§¸ í˜ì´ì§€ì˜ í…ìŠ¤íŠ¸"
                                oninput="updateCounts()"
                            ></textarea>
                        </div>
                    </div>

                    <!-- ì¹´ìš´íŠ¸ ì •ë³´ -->
                    <div id="countWarning" style="padding: 12px; border-radius: 8px; margin-bottom: 15px; display: none;"></div>

                    <!-- ë²„íŠ¼ -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="loadExistingData()">ğŸ”„ ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button class="btn btn-primary" onclick="previewAll()">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</button>
                        <button class="btn btn-success" onclick="saveAllPages()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
                        <button class="btn" onclick="openLearningWordsModal()" style="background: linear-gradient(135deg, #FF6B9D 0%, #FFA500 100%); color: white; border: none;">ğŸ® í•™ìŠµ ë‹¨ì–´ ì„¤ì •</button>
                    </div>

                    <!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
                    <div id="pagePreviewSection" style="display: none;">
                        <h4 style="color: #4FC3F7; margin-bottom: 15px;">ğŸ“„ í˜ì´ì§€ ë¯¸ë¦¬ë³´ê¸°</h4>
                        <div id="pagePreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;"></div>
                    </div>
                </div>

                <!-- Step 3: ì™„ë£Œ -->
                <div id="step3" class="edit-step" style="display: none; text-align: center;">
                    <div style="font-size: 80px; margin-bottom: 20px;">âœ…</div>
                    <h3 style="color: #81C784; margin-bottom: 15px;">ë™í™”ì±…ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
                    <p style="color: #666; margin-bottom: 30px;">ì´ì œ ë©”ì¸ í˜ì´ì§€ì—ì„œ ë™í™”ì±…ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-secondary" onclick="closeEditModal(); loadStorybooks();">ëª©ë¡ìœ¼ë¡œ</button>
                        <button class="btn btn-primary" onclick="viewStorybook()">ğŸ“– ë™í™”ì±… ë³´ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allStorybooks = [];
        let currentEditId = null;

        // ë™í™”ì±… ëª©ë¡ ë¡œë“œ
        async function loadStorybooks() {
            try {
                const response = await fetch('/api/storybooks');
                const data = await response.json();
                allStorybooks = data.storybooks;
                displayStorybooks(allStorybooks);
            } catch (error) {
                document.getElementById('storybookList').innerHTML = 
                    '<div class="loading" style="color: #E57373;">ë™í™”ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>';
            }
        }

        // ë™í™”ì±… í‘œì‹œ
        function displayStorybooks(storybooks) {
            const container = document.getElementById('storybookList');
            
            if (storybooks.length === 0) {
                container.innerHTML = '<div class="loading">ë“±ë¡ëœ ë™í™”ì±…ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ë§Œë“¤ì–´ë³´ì„¸ìš”!</div>';
                return;
            }

            container.innerHTML = storybooks.map(story => `
                <div class="card">
                    <img 
                        src="${story.coverImageUrl || 'https://via.placeholder.com/400x300?text=No+Image'}" 
                        alt="${story.title}"
                        class="card-image"
                        onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'"
                    >
                    <div class="card-content">
                        <h3 class="card-title">${story.title}</h3>
                        <p class="card-author">âœï¸ ${story.author || 'ì‘ê°€ ë¯¸ìƒ'}</p>
                        <div class="card-meta">
                            <span>ğŸ¯ ${story.ageGroup || 'ì „ì²´'}</span>
                            <span>ğŸ“„ ${story.pageCount}í˜ì´ì§€</span>
                        </div>
                        <div class="tags">
                            ${story.tags.map(tag => `<span class="tag">#${tag}</span>`).join('')}
                            ${story.isPublished ? '<span class="tag" style="background: #C8E6C9; color: #4CAF50;">âœ… ê³µê°œ</span>' : '<span class="tag" style="background: #FFCDD2; color: #F44336;">ğŸ”’ ë¹„ê³µê°œ</span>'}
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 15px;">
                            <button class="btn btn-primary" style="flex: 1; padding: 8px;" onclick="editStorybook('${story.id}')">âœï¸ í¸ì§‘</button>
                            <button class="btn btn-danger" style="padding: 8px;" onclick="deleteStorybook('${story.id}', '${story.title}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ìƒì„± ëª¨ë‹¬ ì—´ê¸°
        function openCreateModal() {
            document.getElementById('createModal').classList.add('show');
            document.getElementById('createForm').reset();
        }

        // ìƒì„± ëª¨ë‹¬ ë‹«ê¸°
        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('show');
        }

        // ë™í™”ì±… ìƒì„±
        async function createStorybook(event) {
            event.preventDefault();

            const tags = document.getElementById('tags').value
                .split(',')
                .map(t => t.trim())
                .filter(t => t);

            const data = {
                title: document.getElementById('title').value,
                author: document.getElementById('author').value,
                coverImageUrl: document.getElementById('coverImageUrl').value,
                ageGroup: document.getElementById('ageGroup').value,
                tags: tags,
                description: document.getElementById('description').value
            };

            try {
                const response = await fetch('/api/admin/storybooks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    closeCreateModal();
                    alert('âœ… ë™í™”ì±…ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    currentEditId = result.id;
                    await loadStoryDetail(result.id);
                    openEditModal();
                    showStep(2);
                } else {
                    alert('âŒ ìƒì„± ì‹¤íŒ¨: ' + result.error);
                }
            } catch (error) {
                alert('âŒ ìƒì„± ì‹¤íŒ¨: ' + error.message);
            }
        }

        // í¸ì§‘ ëª¨ë‹¬ ì—´ê¸°
        function openEditModal() {
            document.getElementById('editModal').classList.add('show');
        }

        // í¸ì§‘ ëª¨ë‹¬ ë‹«ê¸°
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            currentEditId = null;
            showStep(1);
        }

        // ë™í™”ì±… í¸ì§‘
        async function editStorybook(id) {
            currentEditId = id;
            await loadStoryDetail(id);
            openEditModal();
            showStep(1);
        }

        // ë™í™”ì±… ìƒì„¸ ë¡œë“œ
        async function loadStoryDetail(id) {
            try {
                const response = await fetch(`/api/storybooks/${id}`);
                const story = await response.json();

                document.getElementById('editTitle').value = story.title || '';
                document.getElementById('editAuthor').value = story.author || '';
                document.getElementById('editCoverImageUrl').value = story.coverImageUrl || '';
                document.getElementById('editAgeGroup').value = story.ageGroup || '';
                document.getElementById('editTags').value = story.tags.join(', ');
                document.getElementById('editIsPublished').value = story.isPublished ? 'true' : 'false';

                updateCurrentPageInfo(story.pages.length);
            } catch (error) {
                alert('ë™í™”ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê¸°ë³¸ ì •ë³´ ì €ì¥
        async function saveBasicInfo() {
            const tags = document.getElementById('editTags').value
                .split(',')
                .map(t => t.trim())
                .filter(t => t);

            const data = {
                title: document.getElementById('editTitle').value,
                author: document.getElementById('editAuthor').value,
                coverImageUrl: document.getElementById('editCoverImageUrl').value,
                ageGroup: document.getElementById('editAgeGroup').value,
                tags: tags,
                isPublished: document.getElementById('editIsPublished').value === 'true'
            };

            try {
                const response = await fetch(`/api/admin/storybooks/${currentEditId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    // Step 2ë¡œ ì´ë™í•˜ë©´ì„œ ê¸°ì¡´ ë°ì´í„° ìë™ ë¡œë“œ
                    await loadExistingData();
                    showStep(2);
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + result.error);
                }
            } catch (error) {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadExistingData() {
            try {
                const response = await fetch(`/api/storybooks/${currentEditId}`);
                const story = await response.json();

                if (story.pages && story.pages.length > 0) {
                    // ì´ë¯¸ì§€ URL ì¶”ì¶œ
                    const imageUrls = story.pages.map(p => p.imageUrl || '').join('\n');
                    document.getElementById('bulkImageUrls').value = imageUrls;

                    // í…ìŠ¤íŠ¸ ì¶”ì¶œ
                    const texts = story.pages.map(p => p.text || '').join('\n---\n');
                    document.getElementById('bulkTexts').value = texts;

                    updateCounts();
                    updateCurrentPageInfo(story.pages.length);
                    
                    // ìë™ìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸° ìƒì„±
                    previewAll();
                } else {
                    updateCurrentPageInfo(0);
                }
            } catch (error) {
                console.error('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                updateCurrentPageInfo(0);
            }
        }

        // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        function updateCounts() {
            const imageUrls = document.getElementById('bulkImageUrls').value
                .split('\n')
                .map(url => url.trim())
                .filter(url => url);

            const texts = document.getElementById('bulkTexts').value
                .split('---')
                .map(t => t.trim())
                .filter(t => t);

            document.getElementById('imageUrlCount').textContent = imageUrls.length;
            document.getElementById('textCount').textContent = texts.length;

            // ê²½ê³  ë©”ì‹œì§€
            const warning = document.getElementById('countWarning');
            if (imageUrls.length > 0 && texts.length > 0 && imageUrls.length !== texts.length) {
                warning.style.display = 'block';
                warning.style.background = '#FFCDD2';
                warning.style.color = '#C62828';
                warning.innerHTML = `âš ï¸ <strong>ì£¼ì˜!</strong> ì´ë¯¸ì§€ ${imageUrls.length}ê°œì™€ í…ìŠ¤íŠ¸ ${texts.length}ê°œì˜ ìˆ˜ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!`;
            } else if (imageUrls.length === texts.length && imageUrls.length > 0) {
                warning.style.display = 'block';
                warning.style.background = '#C8E6C9';
                warning.style.color = '#2E7D32';
                warning.innerHTML = `âœ… <strong>ì™„ë²½í•©ë‹ˆë‹¤!</strong> ì´ë¯¸ì§€ì™€ í…ìŠ¤íŠ¸ê°€ ${imageUrls.length}ê°œë¡œ ì¼ì¹˜í•©ë‹ˆë‹¤.`;
            } else {
                warning.style.display = 'none';
            }
        }

        // ì „ì²´ ë¯¸ë¦¬ë³´ê¸°
        function previewAll() {
            const imageUrls = document.getElementById('bulkImageUrls').value
                .split('\n')
                .map(url => url.trim())
                .filter(url => url);

            const texts = document.getElementById('bulkTexts').value
                .split('---')
                .map(t => t.trim())
                .filter(t => t);

            if (imageUrls.length === 0) {
                alert('ì´ë¯¸ì§€ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const maxLength = Math.max(imageUrls.length, texts.length);
            const preview = document.getElementById('pagePreview');
            
            preview.innerHTML = Array.from({ length: maxLength }, (_, i) => {
                const imageUrl = imageUrls[i] || '';
                const text = texts[i] || '';
                const hasImage = !!imageUrl;
                const hasText = !!text;

                return `
                    <div style="border: 2px solid ${hasImage && hasText ? '#4CAF50' : '#FF9800'}; border-radius: 10px; padding: 10px; background: white;">
                        <div style="font-weight: bold; color: #FF6B9D; margin-bottom: 8px;">
                            í˜ì´ì§€ ${i + 1}
                            ${!hasImage ? '<span style="color: #F44336; font-size: 12px;"> âš ï¸ ì´ë¯¸ì§€ ì—†ìŒ</span>' : ''}
                            ${!hasText ? '<span style="color: #F44336; font-size: 12px;"> âš ï¸ í…ìŠ¤íŠ¸ ì—†ìŒ</span>' : ''}
                        </div>
                        <img 
                            src="${imageUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'150\'%3E%3Crect fill=\'%23f5f5f5\' width=\'200\' height=\'150\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' fill=\'%23999\'%3Eì´ë¯¸ì§€ ì—†ìŒ%3C/text%3E%3C/svg%3E'}" 
                            style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;"
                            onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'200\\' height=\\'150\\'%3E%3Crect fill=\\'%23ffcdd2\\' width=\\'200\\' height=\\'150\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' fill=\\'%23c62828\\'%3Eë¡œë“œ ì‹¤íŒ¨%3C/text%3E%3C/svg%3E'"
                        >
                        <div style="font-size: 12px; color: #666; line-height: 1.4; max-height: 60px; overflow: hidden;">
                            ${text ? text.substring(0, 80) + (text.length > 80 ? '...' : '') : '<span style="color: #999;">í…ìŠ¤íŠ¸ ì—†ìŒ</span>'}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('pagePreviewSection').style.display = 'block';
            
            // ìŠ¤í¬ë¡¤
            setTimeout(() => {
                document.getElementById('pagePreviewSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        // ëª¨ë‘ ì €ì¥
        async function saveAllPages() {
            const imageUrls = document.getElementById('bulkImageUrls').value
                .split('\n')
                .map(url => url.trim())
                .filter(url => url);

            const texts = document.getElementById('bulkTexts').value
                .split('---')
                .map(t => t.trim())
                .filter(t => t);

            if (imageUrls.length === 0) {
                alert('ì´ë¯¸ì§€ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (imageUrls.length !== texts.length) {
                if (!confirm(`âš ï¸ ì´ë¯¸ì§€ ${imageUrls.length}ê°œì™€ í…ìŠ¤íŠ¸ ${texts.length}ê°œì˜ ìˆ˜ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nê·¸ë˜ë„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
            }

            try {
                // 1ë‹¨ê³„: ì´ë¯¸ì§€ ì €ì¥
                const imageResponse = await fetch(`/api/admin/storybooks/${currentEditId}/pages/bulk-images`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imageUrls: imageUrls, replace: true })
                });

                const imageResult = await imageResponse.json();
                if (!imageResult.success) {
                    throw new Error('ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: ' + imageResult.error);
                }

                // 2ë‹¨ê³„: í…ìŠ¤íŠ¸ ì €ì¥
                if (texts.length > 0) {
                    const textResponse = await fetch(`/api/admin/storybooks/${currentEditId}/pages/bulk-texts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ texts: texts.join('\n---\n') })
                    });

                    const textResult = await textResponse.json();
                    if (!textResult.success) {
                        throw new Error('í…ìŠ¤íŠ¸ ì €ì¥ ì‹¤íŒ¨: ' + (textResult.warning || textResult.error));
                    }
                }

                alert(`âœ… ì €ì¥ ì™„ë£Œ!\nì´ ${imageResult.totalPages}ê°œì˜ í˜ì´ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                showStep(3);
            } catch (error) {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ìŠ¤í… ì „í™˜
        function showStep(step) {
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`step${i}`).style.display = 'none';
            }
            document.getElementById(`step${step}`).style.display = 'block';
        }

        // í˜ì´ì§€ ìˆ˜ ì •ë³´ ì—…ë°ì´íŠ¸
        function updatePageCountInfo(count) {
            const info = document.getElementById('pageCountInfo');
            if (info) {
                info.textContent = `ğŸ“Š í˜„ì¬ í˜ì´ì§€ ìˆ˜: ${count}ê°œ`;
                info.style.color = count > 0 ? '#4CAF50' : '#F44336';
            }
        }

        // í˜„ì¬ í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateCurrentPageInfo(count) {
            const info = document.getElementById('currentPageInfo');
            if (info) {
                if (count === 0) {
                    info.innerHTML = 'ğŸ“„ í˜„ì¬ ì €ì¥ëœ í˜ì´ì§€: ì—†ìŒ (ìƒˆë¡œ ì‘ì„±í•˜ì„¸ìš”)';
                    info.style.background = '#E3F2FD';
                    info.style.color = '#1976D2';
                } else {
                    info.innerHTML = `ğŸ“„ í˜„ì¬ ì €ì¥ëœ í˜ì´ì§€: <strong>${count}ê°œ</strong> (ê¸°ì¡´ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤. ìˆ˜ì • í›„ ì €ì¥í•˜ë©´ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤)`;
                    info.style.background = '#C8E6C9';
                    info.style.color = '#2E7D32';
                }
            }
        }

        // ë™í™”ì±… ë³´ê¸°
        function viewStorybook() {
            window.open(`/reader/${currentEditId}`, '_blank');
        }

        // ë™í™”ì±… ì‚­ì œ
        async function deleteStorybook(id, title) {
            if (!confirm(`ì •ë§ë¡œ "${title}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/storybooks/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    alert('âœ… ë™í™”ì±…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadStorybooks();
                } else {
                    alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + result.error);
                }
            } catch (error) {
                alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì´ˆê¸° ë¡œë“œ
        loadStorybooks();

        // ========== í•™ìŠµ ë‹¨ì–´ ê´€ë¦¬ ==========
        
        function openLearningWordsModal() {
            if (!currentEditId) {
                alert('âš ï¸ ë¨¼ì € ë™í™”ì±…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const modal = prompt('í•™ìŠµ ë‹¨ì–´ ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì…ë ¥: /admin/learning-words?story=' + currentEditId);
            if (modal !== null) {
                window.open(`/admin/learning-words?story=${currentEditId}`, '_blank');
            }
        }
    </script>
</body>
</html>
