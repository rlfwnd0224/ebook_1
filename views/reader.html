<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“– ë™í™”ì±… ì½ê¸°</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <a href="/" class="btn btn-secondary">ğŸ  ëª©ë¡ìœ¼ë¡œ</a>
            <h2 id="storyTitle" style="color: #FF6B9D; margin: 0;">ë™í™”ì±… ì œëª©</h2>
            <div style="width: 120px;"></div>
        </div>

        <div class="reader-container">
            <div class="reader-content">
                <img 
                    id="pageImage" 
                    class="reader-image" 
                    src="" 
                    alt="ë™í™”ì±… ì´ë¯¸ì§€"
                    onerror="this.src='https://via.placeholder.com/800x600?text=Image+Not+Found'"
                >
                <div id="pageText" class="reader-text">
                    ë™í™”ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>
            <div class="reader-controls">
                <div class="page-nav">
                    <button class="nav-btn" id="prevBtn" onclick="prevPage()" disabled>â—€</button>
                    <button class="nav-btn" id="nextBtn" onclick="nextPage()" disabled>â–¶</button>
                </div>
                <div class="page-indicator">
                    <span id="currentPage">1</span> / <span id="totalPages">1</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="toggleAutoPlay()">
                        <span id="autoPlayIcon">â–¶ï¸</span> ìë™ ì½ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- TTS ì»¨íŠ¸ë¡¤ -->
        <div class="tts-controls">
            <button class="tts-btn" id="playBtn" onclick="playTTS()" title="ì½ì–´ì£¼ê¸°">
                ğŸ”Š
            </button>
            <button class="tts-btn" id="pauseBtn" onclick="pauseTTS()" title="ì¼ì‹œì •ì§€" style="display: none;">
                â¸ï¸
            </button>
            <button class="tts-btn" onclick="stopTTS()" title="ì •ì§€">
                â¹ï¸
            </button>
            <div class="speed-control">
                <button class="speed-btn" onclick="setSpeed(0.8)" data-speed="0.8">ğŸ¢ ëŠë¦¼</button>
                <button class="speed-btn active" onclick="setSpeed(1.0)" data-speed="1.0">ğŸ° ë³´í†µ</button>
                <button class="speed-btn" onclick="setSpeed(1.3)" data-speed="1.3">ğŸ† ë¹ ë¦„</button>
            </div>
        </div>
    </div>

    <script>
        let currentStory = null;
        let currentPageIndex = 0;
        let synthesis = window.speechSynthesis;
        let currentUtterance = null;
        let isAutoPlay = false;
        let currentSpeed = 1.0;

        // ë™í™”ì±… ë¡œë“œ
        async function loadStory() {
            const storyId = window.location.pathname.split('/').pop();
            try {
                const response = await fetch(`/api/storybooks/${storyId}`);
                currentStory = await response.json();
                
                document.getElementById('storyTitle').textContent = currentStory.title;
                document.getElementById('totalPages').textContent = currentStory.pages.length;
                
                // ì €ì¥ëœ ì§„í–‰ë¥  ë¶ˆëŸ¬ì˜¤ê¸°
                const savedProgress = localStorage.getItem(`story-${storyId}-progress`);
                if (savedProgress) {
                    currentPageIndex = parseInt(savedProgress);
                }
                
                displayPage(currentPageIndex);
            } catch (error) {
                document.getElementById('pageText').textContent = 'ë™í™”ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ ğŸ˜¢';
            }
        }

        // í˜ì´ì§€ í‘œì‹œ
        function displayPage(index) {
            if (!currentStory || !currentStory.pages[index]) return;

            const page = currentStory.pages[index];
            
            document.getElementById('pageImage').src = page.imageUrl;
            document.getElementById('pageText').textContent = page.text;
            document.getElementById('currentPage').textContent = index + 1;

            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').disabled = index === currentStory.pages.length - 1;

            // ì§„í–‰ë¥  ì €ì¥
            const storyId = currentStory.id;
            localStorage.setItem(`story-${storyId}-progress`, index);

            // TTS ì •ì§€
            stopTTS();

            // ìë™ ì¬ìƒì´ ì¼œì ¸ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì½ê¸°
            if (isAutoPlay) {
                setTimeout(() => playTTS(), 500);
            }
        }

        // ì´ì „ í˜ì´ì§€
        function prevPage() {
            if (currentPageIndex > 0) {
                currentPageIndex--;
                displayPage(currentPageIndex);
            }
        }

        // ë‹¤ìŒ í˜ì´ì§€
        function nextPage() {
            if (currentPageIndex < currentStory.pages.length - 1) {
                currentPageIndex++;
                displayPage(currentPageIndex);
            }
        }

        // ìë™ ì½ê¸° í† ê¸€
        function toggleAutoPlay() {
            isAutoPlay = !isAutoPlay;
            const icon = document.getElementById('autoPlayIcon');
            icon.textContent = isAutoPlay ? 'â¸ï¸' : 'â–¶ï¸';
            
            if (isAutoPlay) {
                playTTS();
            }
        }

        // TTS ì¬ìƒ
        function playTTS() {
            if (!currentStory || !currentStory.pages[currentPageIndex]) return;

            stopTTS();

            const text = currentStory.pages[currentPageIndex].text;
            if (!text) return;

            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'ko-KR';
            currentUtterance.rate = currentSpeed;
            
            // ìŒì„± ì„ íƒ (í•œêµ­ì–´ ì—¬ì„± ìŒì„± ìš°ì„ )
            const voices = synthesis.getVoices();
            const koreanVoice = voices.find(voice => voice.lang.includes('ko'));
            if (koreanVoice) {
                currentUtterance.voice = koreanVoice;
            }

            // ì¬ìƒ ì™„ë£Œ ì‹œ ë‹¤ìŒ í˜ì´ì§€ë¡œ
            currentUtterance.onend = () => {
                document.getElementById('playBtn').style.display = 'block';
                document.getElementById('pauseBtn').style.display = 'none';
                document.getElementById('playBtn').classList.remove('active');
                
                if (isAutoPlay && currentPageIndex < currentStory.pages.length - 1) {
                    setTimeout(() => {
                        nextPage();
                    }, 1000);
                }
            };

            synthesis.speak(currentUtterance);
            document.getElementById('playBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'block';
            document.getElementById('playBtn').classList.add('active');
        }

        // TTS ì¼ì‹œì •ì§€
        function pauseTTS() {
            if (synthesis.speaking) {
                synthesis.pause();
                document.getElementById('playBtn').style.display = 'block';
                document.getElementById('pauseBtn').style.display = 'none';
            }
        }

        // TTS ì •ì§€
        function stopTTS() {
            synthesis.cancel();
            document.getElementById('playBtn').style.display = 'block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('playBtn').classList.remove('active');
        }

        // ì†ë„ ì„¤ì •
        function setSpeed(speed) {
            currentSpeed = speed;
            
            // ë²„íŠ¼ active ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseFloat(btn.dataset.speed) === speed) {
                    btn.classList.add('active');
                }
            });

            // ì¬ìƒ ì¤‘ì´ë©´ ì†ë„ ì ìš©
            if (synthesis.speaking) {
                const wasPlaying = !synthesis.paused;
                stopTTS();
                if (wasPlaying) {
                    setTimeout(() => playTTS(), 100);
                }
            }
        }

        // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                prevPage();
            } else if (e.key === 'ArrowRight') {
                nextPage();
            } else if (e.key === ' ') {
                e.preventDefault();
                if (synthesis.speaking && !synthesis.paused) {
                    pauseTTS();
                } else {
                    playTTS();
                }
            }
        });

        // ìŒì„± ë¡œë“œ ëŒ€ê¸°
        if (synthesis.onvoiceschanged !== undefined) {
            synthesis.onvoiceschanged = () => {};
        }

        // ì´ˆê¸° ë¡œë“œ
        loadStory();
    </script>
</body>
</html>
