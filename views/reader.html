<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“– ë™í™”ì±… ì½ê¸°</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- ëª¨ë°”ì¼ ë””ë²„ê¹…ìš© Eruda ì½˜ì†” -->
    <script src="https://cdn.jsdelivr.net/npm/eruda@3.0.1/eruda.min.js"></script>
    <script>eruda.init();</script>
</head>
<body>
    <div class="container">
        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <a href="/" class="btn btn-secondary">ğŸ  ëª©ë¡ìœ¼ë¡œ</a>
            <h2 id="storyTitle" style="color: #FF6B9D; margin: 0;">ë™í™”ì±… ì œëª©</h2>
            <div style="width: 120px;"></div>
        </div>

        <div class="reader-container">
            <div class="reader-content">
                <img 
                    id="pageImage" 
                    class="reader-image" 
                    src="" 
                    alt="ë™í™”ì±… ì´ë¯¸ì§€"
                    style="transition: opacity 0.3s ease;"
                >
                <div id="pageText" class="reader-text">
                    ë™í™”ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>
            <div class="reader-controls">
                <div class="page-nav">
                    <button class="nav-btn" id="prevBtn" onclick="prevPage()" disabled>â—€</button>
                    <button class="nav-btn" id="nextBtn" onclick="nextPage()" disabled>â–¶</button>
                </div>
                <div class="page-indicator">
                    <span id="currentPage">1</span> / <span id="totalPages">1</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="toggleAutoPlay()">
                        <span id="autoPlayIcon">â–¶ï¸</span> ìë™ ì½ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- TTS ì»¨íŠ¸ë¡¤ -->
        <div class="tts-controls" id="ttsControls">
            <button class="tts-toggle" onclick="toggleTTSControls()" title="TTS ì»¨íŠ¸ë¡¤">
                ğŸµ
            </button>
            <div class="tts-content">
                <button class="tts-btn" id="playBtn" onclick="playTTS()" title="ì½ì–´ì£¼ê¸°">
                    ğŸ”Š
                </button>
                <button class="tts-btn" id="pauseBtn" onclick="pauseTTS()" title="ì¼ì‹œì •ì§€" style="display: none;">
                    â¸ï¸
                </button>
                <button class="tts-btn" onclick="stopTTS()" title="ì •ì§€">
                    â¹ï¸
                </button>
                <div class="speed-control">
                    <button class="speed-btn" onclick="setSpeed(0.8)" data-speed="0.8">ğŸ¢ ëŠë¦¼</button>
                    <button class="speed-btn active" onclick="setSpeed(1.0)" data-speed="1.0">ğŸ° ë³´í†µ</button>
                    <button class="speed-btn" onclick="setSpeed(1.3)" data-speed="1.3">ğŸ† ë¹ ë¦„</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStory = null;
        let currentPageIndex = 0;
        let synthesis = null;
        let currentUtterance = null;
        let isAutoPlay = false;
        let currentSpeed = 1.0;
        let ttsControlsExpanded = true;

        // ì•ˆì „í•˜ê²Œ speechSynthesis ì´ˆê¸°í™”
        try {
            synthesis = window.speechSynthesis || null;
        } catch (e) {
            console.warn('âš ï¸ TTS ì‚¬ìš© ë¶ˆê°€:', e);
        }

        // TTS ì»¨íŠ¸ë¡¤ í† ê¸€
        function toggleTTSControls() {
            const controls = document.getElementById('ttsControls');
            ttsControlsExpanded = !ttsControlsExpanded;
            
            if (ttsControlsExpanded) {
                controls.classList.remove('collapsed');
            } else {
                controls.classList.add('collapsed');
            }
        }

        // ì´ë¯¸ì§€ ë¡œë“œ ì˜¤ë¥˜ ì²˜ë¦¬ - SVG placeholder ìƒì„±
        function handleImageError(img) {
            const svg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='600' viewBox='0 0 800 600'%3E%3Crect fill='%23f5f5f5' width='800' height='600'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='24' fill='%23999'%3Eì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤%3C/text%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='16' fill='%23bbb'%3Eê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì´ë¯¸ì§€ URLì„ í™•ì¸í•´ì£¼ì„¸ìš”%3C/text%3E%3C/svg%3E`;
            img.src = svg;
            img.onerror = null; // ë¬´í•œ ë£¨í”„ ë°©ì§€
        }

        // ë™í™”ì±… ë¡œë“œ
        async function loadStory() {
            const storyId = window.location.pathname.split('/').pop();
            console.log('ğŸ“– ë™í™”ì±… ë¡œë“œ ì‹œì‘:', storyId);
            
            try {
                const response = await fetch(`/api/storybooks/${storyId}`);
                console.log('âœ… API ì‘ë‹µ ë°›ìŒ:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                currentStory = await response.json();
                console.log('âœ… ë™í™”ì±… ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', currentStory.title, `${currentStory.pages.length}í˜ì´ì§€`);
                
                document.getElementById('storyTitle').textContent = currentStory.title;
                document.getElementById('totalPages').textContent = currentStory.pages.length;
                
                // ì €ì¥ëœ ì§„í–‰ë¥  ë¶ˆëŸ¬ì˜¤ê¸°
                const savedProgress = localStorage.getItem(`story-${storyId}-progress`);
                if (savedProgress) {
                    currentPageIndex = parseInt(savedProgress);
                    console.log('ğŸ“š ì €ì¥ëœ ì§„í–‰ë¥ :', currentPageIndex);
                }
                
                displayPage(currentPageIndex);
            } catch (error) {
                console.error('âŒ ë™í™”ì±… ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('pageText').textContent = 'ë™í™”ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ ğŸ˜¢\n' + error.message;
                alert('ë™í™”ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // í˜ì´ì§€ í‘œì‹œ
        function displayPage(index) {
            console.log('ğŸ“„ í˜ì´ì§€ í‘œì‹œ ì‹œì‘:', index);
            
            if (!currentStory) {
                console.error('âŒ currentStoryê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            if (!currentStory.pages[index]) {
                console.error('âŒ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤:', index);
                return;
            }

            const page = currentStory.pages[index];
            console.log('âœ… í˜ì´ì§€ ë°ì´í„°:', page.pageNumber, page.imageUrl ? 'ì´ë¯¸ì§€ ìˆìŒ' : 'ì´ë¯¸ì§€ ì—†ìŒ', page.text ? `í…ìŠ¤íŠ¸ ${page.text.length}ì` : 'í…ìŠ¤íŠ¸ ì—†ìŒ');
            
            // ì´ë¯¸ì§€ ë¡œë”© ì²˜ë¦¬
            const imgElement = document.getElementById('pageImage');
            imgElement.style.opacity = '0.5';
            
            // ì´ë¯¸ì§€ URL ìœ íš¨ì„± ê²€ì‚¬ ë° ë¡œë”©
            if (page.imageUrl && page.imageUrl.trim() && page.imageUrl !== '') {
                // ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ
                imgElement.onload = function() {
                    imgElement.style.opacity = '1';
                };
                
                // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ - SVG placeholder ì‚¬ìš©
                imgElement.onerror = function() {
                    console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', page.imageUrl);
                    handleImageError(imgElement);
                    imgElement.style.opacity = '1';
                };
                
                imgElement.src = page.imageUrl;
            } else {
                // URLì´ ì—†ëŠ” ê²½ìš° - SVG placeholder ì‚¬ìš©
                handleImageError(imgElement);
                imgElement.style.opacity = '1';
            }
            
            // í…ìŠ¤íŠ¸ í‘œì‹œ
            const textElement = document.getElementById('pageText');
            if (page.text && page.text.trim()) {
                textElement.textContent = page.text;
                textElement.style.color = '#2c3e50';
            } else {
                textElement.textContent = '(í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤)';
                textElement.style.color = '#999';
            }
            
            document.getElementById('currentPage').textContent = index + 1;

            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').disabled = index === currentStory.pages.length - 1;

            // ì§„í–‰ë¥  ì €ì¥
            const storyId = currentStory.id;
            localStorage.setItem(`story-${storyId}-progress`, index);

            // TTS ì •ì§€
            stopTTS();

            // ìë™ ì¬ìƒì´ ì¼œì ¸ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì½ê¸°
            if (isAutoPlay && page.text && page.text.trim()) {
                setTimeout(() => playTTS(), 500);
            }
        }

        // ì´ì „ í˜ì´ì§€
        function prevPage() {
            if (currentPageIndex > 0) {
                currentPageIndex--;
                displayPage(currentPageIndex);
            }
        }

        // ë‹¤ìŒ í˜ì´ì§€
        function nextPage() {
            if (currentPageIndex < currentStory.pages.length - 1) {
                currentPageIndex++;
                displayPage(currentPageIndex);
            }
        }

        // ìë™ ì½ê¸° í† ê¸€
        function toggleAutoPlay() {
            isAutoPlay = !isAutoPlay;
            const icon = document.getElementById('autoPlayIcon');
            icon.textContent = isAutoPlay ? 'â¸ï¸' : 'â–¶ï¸';
            
            if (isAutoPlay) {
                playTTS();
            }
        }

        // TTS ì¬ìƒ
        function playTTS() {
            if (!synthesis) {
                console.warn('âš ï¸ TTS ì‚¬ìš© ë¶ˆê°€');
                return;
            }
            
            if (!currentStory || !currentStory.pages[currentPageIndex]) return;

            stopTTS();

            const text = currentStory.pages[currentPageIndex].text;
            if (!text) return;

            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'ko-KR';
            currentUtterance.rate = currentSpeed;
            
            // ìŒì„± ì„ íƒ (í•œêµ­ì–´ ì—¬ì„± ìŒì„± ìš°ì„ )
            const voices = synthesis.getVoices();
            const koreanVoice = voices.find(voice => voice.lang.includes('ko'));
            if (koreanVoice) {
                currentUtterance.voice = koreanVoice;
            }

            // ì¬ìƒ ì™„ë£Œ ì‹œ ë‹¤ìŒ í˜ì´ì§€ë¡œ
            currentUtterance.onend = () => {
                document.getElementById('playBtn').style.display = 'block';
                document.getElementById('pauseBtn').style.display = 'none';
                document.getElementById('playBtn').classList.remove('active');
                
                if (isAutoPlay && currentPageIndex < currentStory.pages.length - 1) {
                    setTimeout(() => {
                        nextPage();
                    }, 1000);
                }
            };

            synthesis.speak(currentUtterance);
            document.getElementById('playBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'block';
            document.getElementById('playBtn').classList.add('active');
        }

        // TTS ì¼ì‹œì •ì§€
        function pauseTTS() {
            if (!synthesis) return;
            
            if (synthesis.speaking) {
                synthesis.pause();
                document.getElementById('playBtn').style.display = 'block';
                document.getElementById('pauseBtn').style.display = 'none';
            }
        }

        // TTS ì •ì§€
        function stopTTS() {
            if (!synthesis) return;
            
            synthesis.cancel();
            document.getElementById('playBtn').style.display = 'block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('playBtn').classList.remove('active');
        }

        // ì†ë„ ì„¤ì •
        function setSpeed(speed) {
            currentSpeed = speed;
            
            // ë²„íŠ¼ active ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseFloat(btn.dataset.speed) === speed) {
                    btn.classList.add('active');
                }
            });

            // ì¬ìƒ ì¤‘ì´ë©´ ì†ë„ ì ìš©
            if (synthesis.speaking) {
                const wasPlaying = !synthesis.paused;
                stopTTS();
                if (wasPlaying) {
                    setTimeout(() => playTTS(), 100);
                }
            }
        }

        // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                prevPage();
            } else if (e.key === 'ArrowRight') {
                nextPage();
            } else if (e.key === ' ') {
                e.preventDefault();
                if (synthesis && synthesis.speaking && !synthesis.paused) {
                    pauseTTS();
                } else {
                    playTTS();
                }
            }
        });

        // ìŒì„± ë¡œë“œ ëŒ€ê¸° (ì•ˆì „í•˜ê²Œ)
        if (synthesis && synthesis.onvoiceschanged !== undefined) {
            synthesis.onvoiceschanged = () => {
                console.log('âœ… TTS ìŒì„± ë¡œë“œ ì™„ë£Œ');
            };
        }

        // ì´ˆê¸° ë¡œë“œ
        loadStory();
    </script>
</body>
</html>
